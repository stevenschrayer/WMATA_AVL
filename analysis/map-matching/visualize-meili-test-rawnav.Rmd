---
title: "Meili Map Matching Test"
output: 
  html_notebook:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r include=FALSE}
library(tidyverse)
library(sf)
library(mapview)

path_sp <- "C:/OD/Foursquare ITP/Projects - WMATA Datamart"

path_data <-
  file.path(
    path_sp,
    "Task 3 - Bus Priority",
    "Data",
    "01-Interim"
  )

rawnav <-
  read_csv(
    file.path(path_data,"rawnav_matched.csv")
  ) 

rawnav_matched <-
  rawnav %>%
  select(
    filename,
    index_run_start,
    index_loc,
    latmatch:road_class,
  ) %>%
  st_as_sf(
    .,
    coords = c("longmatch", "latmatch"),
    crs = 4326L, #WGS84
    agr = "constant",
    remove = FALSE
  )

rawnav_og <-
  rawnav %>%
  select(
    filename,
    index_run_start,
    index_loc,
    long,
    lat
  ) %>%
  st_as_sf(
    .,
    coords = c("long", "lat"),
    crs = 4326L, #WGS84
    agr = "constant"
  )

thetripfile <- "rawnav02205171017.txt"
thetripidx <- 1827

rawnav_og_ti <-
  rawnav_og %>%
  filter(
    filename == thetripfile,
    index_run_start == thetripidx
  )
      
rawnav_matched_ti <-
  rawnav_matched %>%
  filter(
    filename == thetripfile,
    index_run_start == thetripidx
  )

```

## Compare before and matched for a single trip instance

### Original and matched
```{r}
# compare
mapview(
  rawnav_og_ti,
  col.regions = "grey30",
  alpha = 0,
  layer.name = "Original"
) +
  mapview(
    rawnav_matched_ti,
    col.regions = "red",
    layer.name = "Matched",
    alpha = 0
  )


```


### Size of miss

```{r, fig.width = 8.5, fig.height = 7}
# look at size of miss
mapview(
  rawnav_og_ti, 
  col.regions = "grey80",
  alpha = 0.5, 
  layer.name = "Original"
) + 
mapview(
  rawnav_matched_ti, 
  zcol = "distance_from_trace_point", 
  layer.name = "Dist. from <br>Orig. Pt. (m)",
  alpha = 0
)

```

### Street Names
```{r, fig.width = 8.5, fig.height = 7}
# edge index
mapview(rawnav_matched_ti, zcol = "street_names", layer.name = "Street Names", alpha = 0)

```

### OSM way ID
```{r, fig.width = 8.5, fig.height = 7}

rawnav_matched_ti %>%
  mutate(
    way_id = as.character(way_id)
  ) %>%
  mapview(., zcol = "way_id", alpha = 0, legend = FALSE)

```

### distance along edge value

The distance along the associated edge for this matched point. For example, if the matched point is halfway along the edge then the value would be 0.5. This value will not exist if this point was unmatched.

 The distance along the associated edge for this matched point. For example, if the matched point is halfway along the edge then the value would be 0.5. This value will not exist if this point was unmatched.
```{r, fig.width = 8.5, fig.height = 7}

mapview(rawnav_matched_ti, zcol = "distance_along_edge", layer.name = "Pct. Distance Along Edge", alpha = 0)

```

### End heading

```{r, fig.width = 8.5, fig.height = 7}
mapview(rawnav_matched_ti, zcol = "end_heading", alpha = 0, layer.name = "Street Heading")

```

## Aggregate across trips

Aggregate speeds across 2017 and 2019 on these edges
```{r}
rawnav_all2 <-
  rawnav %>%
  filter(
    wday %in% c("Monday","Tuesday","Wednesday","Thursday","Friday"),
    pattern == 1 # i think is sb
  ) %>%
  mutate(
    year = lubridate::year(start_date_time),
    hour = lubridate::hour(start_date_time)
  ) %>%
  filter(
    hour %in% c(6,7,8)
  ) %>%
  replace_na(
    list(
      id = "",
      way_id = "",
      street_names =""
    )
  ) %>%
  group_by(
    year,
    id,
    way_id,
    street_names
  ) %>%
  summarize(
    speed_median = quantile(fps_next_sm,.5, na.rm= TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = year,
    values_from = speed_median,
    names_glue = "spd_{year}"
  ) %>%
  mutate(
    speed_chng = (spd_2019 - spd_2017) / spd_2017,
    speed_chng = na_if(speed_chng,Inf)
  ) %>%
  filter(
    complete.cases(.)
  )
```

make a placeholder geom to join to until we reexport the valhalla edges
```{r}

duper <- function(col){
  if_else(dplyr::lead({{col}}) != {{col}},dplyr::lead({{col}}),{{col}})
}

example_geom2 <-
  rawnav_matched_ti %>%
  st_drop_geometry() %>%
  replace_na(
    list(
      id = "",
      way_id = "",
      street_names =""
    )
  ) %>%
  group_by(
    id,
    way_id,
    street_names
  ) %>%
  mutate(
    n = if_else(row_number() == n(),2,1) 
  ) %>%
  uncount(weights = n, .remove = FALSE) %>%
  ungroup() %>%
  select(
    index_loc,
    id,
    way_id,
    street_names,
    longmatch,
    latmatch,
    n
  ) %>%
  mutate(
    across(
      c(
        id,
        way_id,
        street_names
      ),
      ~ duper(.x)
    )
  ) %>%
  filter(
    !is.na(id) & !is.na(way_id) & !is.na(street_names)
  ) %>%
  st_as_sf(
    .,
    coords = c("longmatch", "latmatch"),
    crs = 4326L, #WGS84
    agr = "constant"
  ) %>%
  group_by(
    id,
    way_id,
    street_names
  ) %>%
  summarize(
    do_union=FALSE
  ) %>%
  st_cast("LINESTRING")
```
2017 v 2019 speed changes
```{r, fig.width = 8.5, fig.height = 7}

example_out <-
  example_geom2 %>%
  left_join(
    rawnav_all2,
    by = c(
      "id" = "id",
      "way_id" = "way_id",
      "street_names" = "street_names"
    )
  ) 

mapview(example_out, 
        zcol = "speed_chng",
        layer.name = "2017 to 2019<br>Percent Speed Change",
        lwd = 4,
        legend = TRUE)
```


