---
title: "R Notebook"
output: html_notebook
---


# Setup
```{r include=FALSE}
library(tidyverse)
library(sf)
library(mapview)
library(plotly)

path_sp <- "C:/OD/Foursquare ITP/Projects - WMATA Datamart"

path_data <-
  file.path(
    path_sp,
    "Task 3 - Bus Priority",
    "Data",
    "01-Interim"
  )

```

```{r}
knitr::opts_chunk$set(echo = FALSE)
```


Define useful functions
```{r}

load_rawnav <- 
  function(thepath){
    suppressWarnings({
      read_csv(
        thepath,
        col_types = cols(
          X1 = col_double(),
          index_loc = col_double(),
          lat = col_double(),
          long = col_double(),
          heading = col_double(),
          door_state = col_character(),
          veh_state = col_character(),
          odom_ft = col_double(),
          sec_past_st = col_double(),
          sat_cnt = col_double(),
          stop_window = col_character(),
          blank = col_double(),
          lat_raw = col_double(),
          long_raw = col_double(),
          row_before_apc = col_double(),
          route_pattern = col_character(),
          pattern = col_double(),
          index_run_start = col_double(),
          index_run_end = col_double(),
          filename = col_character(),
          start_date_time = col_datetime(format = ""),
          route = col_character(),
          wday = col_character(),
          odom_ft_next = col_double(),
          sec_past_st_next = col_double(),
          odom_ft_next3 = col_double(),
          sec_past_st_next3 = col_double(),
          secs_marg = col_double(),
          odom_ft_marg = col_double(),
          fps_next = col_double(),
          fps_next3 = col_double()
        )
      )
    })
    
  }


cleanup_things <- function(rawnav){
  rawnav %>%
    st_as_sf(
      ., 
      coords = c("long", "lat"),
      crs = 4326L, #WGS84
      agr = "constant"
    ) %>%
    mutate(
      mins_past_st = sec_past_st / 60,
      mph_next = fps_next / 1.467,
      mph_next3 = fps_next3 / 1.467,
      fps_next_lead = lead(fps_next),
      fps_next3_lead = lead(fps_next3),
      accel_next = (fps_next_lead - fps_next) / (sec_past_st_next - sec_past_st),
      accel_next3 = (fps_next3_lead - fps_next3) / (sec_past_st_next3 - sec_past_st),
      accel_next = round(accel_next,3),
      accel_next3 = round(accel_next3,3),
      accel_mph_next = accel_next / 1.467,
      accel_mph_next3 = accel_next3 / 1.467
    )
}

plot_rawnav <-
  function(rawnav, var, thetitle = NULL){
    if (is.null(thetitle)){
      thetitle = rlang::as_label(enquo(var))
    }
    
    g <- 
      ggplot(
        data = rawnav
      ) +
      geom_line(
        aes(
          y = odom_ft,
          x = sec_past_st
        ),
        color = "grey80"
      ) +
      geom_point(
        aes(
          color = {{var}},
          y = odom_ft,
          x = sec_past_st
        )
      ) +
      xlab("Time Past Trip Start (Seconds)") +
      ylab("Trip Odometer Distance (Feet)") +
      scale_color_gradient2(
        low = "#d7191c",
        mid = "#ffffbf",
        high = "#1a9641"
        # low = ("red"),
        # mid = ("grey90"),
        # high = ("green")
        # low = scales::muted("red"),
        # mid = scales::muted("yellow"),
        # high = scales::muted("green")
      ) +
      theme_minimal() +
      guides(color=guide_legend(title=thetitle))
      
    
    # g
    ggplotly(g, dynamicTicks = TRUE)
  }

plot_rawnav_alt <-
  function(rawnav, var, thetitle = NULL){
    if (is.null(thetitle)){
      thetitle = rlang::as_label(enquo(var))
    }
    
    g <- 
      ggplot(
        data = rawnav
      ) +
      geom_line(
        aes(
          y = odom_ft,
          x = sec_past_st
        ),
        color = "grey80"
      ) +
      geom_point(
        aes(
          color = {{var}},
          y = odom_ft,
          x = sec_past_st
        )
      ) +
      xlab("Time Past Trip Start (Seconds)") +
      ylab("Trip Odometer Distance (Feet)") +
      scale_color_brewer(
        type = "div",
        palette = "RdYlGn"
      ) +
      theme_minimal() +
      guides(color=guide_legend(title=thetitle))
      
    
    # g
    ggplotly(g, dynamicTicks = TRUE)
  }


filter_range <- function(df,themin,themax){
  df %>%
  filter(
    (odom_ft >= themin) & (odom_ft <= themax)
  ) %>%
  select(
    index_loc,
    odom_ft,
    sec_past_st,
    fps_next,
    accel_next
  )
}

```


# Case 1
These are from:
testfile = "rawnav07231210220.txt"
testindex = 9877

```{r}
rawnav_tfixed6 <-
  load_rawnav(
    file.path(path_data,"test_checkfixed6.csv")
  ) %>%
  mutate(
    mins_past_st = sec_past_st / 60,
    accel_next_mph = accel_next / 1.467
  )
```

Let's cut accel/decel into bins centered on zero

```{r}
create_divergent_breaks <- function(vec,totn = 9, zero_cat = TRUE){
  
  # remove 0's (sometimes better for generating breaks)
  abs.vec <- 
  # and set all to positive before calculating
    vec[vec != 0] %>%
    na.omit() %>%
    as.vector() %>%
    abs()
  
  # creating 4 so that we have 3 above mid; could make param
  # TODO: totn should change here if you have zero_cat = FALSE
  ints <- classInt::classIntervals(abs.vec, n= (totn/2)-1, style = "jenks")
  # round top to avoid weird scientific notation, then cut rest to 4 digits
  ints$brks[length(ints$brks)] <- ceiling(ints$brks[length(ints$brks)])
  ints$brks <- round(ints$brks,digits = 4)
  
  if (any(vec <0) & !all(vec <0)){
    allbreaks <- sort(c(-ints$brks, ints$brks))
    
    if (!zero_cat) {
      allbreaks <- allbreaks[!base::duplicated(allbreaks)]
    }
    
  } else {
    stop('didnt plan for non zero midpoint case')
  }
}

```
Run the function to make breaks
```{r}
(thebreaks <-
  rawnav_tfixed6$accel_next_mph %>%
  create_divergent_breaks(totn=11, zero_cat = FALSE) %>%
  round(digits = 4)
)
```

Cut with the function
```{r}
rawnav_tfixed6 <-
  rawnav_tfixed6 %>%
  mutate(
    accel_next_bin = 
      base::cut(
        accel_next_mph,
        breaks = thebreaks,
        include.lowest = TRUE,
        ordered_result = TRUE
      )
  )

```


Visualize
```{r, fig.width=6, fig.height=4}
rawnav_tfixed6 %>%
  plot_rawnav_alt(var = accel_next_bin)
```

Let's try some custom breaks.

This looks too big on the low end
```{r, fig.width=6, fig.height=4}
thebreaks2 <- c(-16, -12, -8, -4, 0, 4, 8, 12, 16)

rawnav_tfixed6 %>%
  mutate(
    accel_next_bin = 
      base::cut(
        accel_next_mph,
        breaks = thebreaks2,
        include.lowest = TRUE,
        ordered_result = TRUE
      )
  ) %>%
  plot_rawnav_alt(var = accel_next_bin)
```


This is maybe better, but at 21k doesn't quite catch the inflection
```{r, fig.width=6, fig.height=4}
thebreaks2 <- c(-16, -8, -4, -2, 0, 2, 4, 8, 16)

rawnav_tfixed6 %>%
  mutate(
    accel_next_bin = 
      base::cut(
        accel_next_mph,
        breaks = thebreaks2,
        include.lowest = TRUE,
        ordered_result = TRUE
      )
  ) %>%
  plot_rawnav_alt(var = accel_next_bin)
```

This looks better at picking out that difference.
```{r, fig.width=6, fig.height=4}
thebreaks2 <- c(-16, -8, -4, -2, -1, 0, 1, 2, 4, 8, 16)

rawnav_tfixed6 %>%
  mutate(
    accel_next_bin = 
      base::cut(
        accel_next_mph,
        breaks = thebreaks2,
        include.lowest = TRUE,
        ordered_result = TRUE
      )
  ) %>%
  plot_rawnav_alt(var = accel_next_bin)
```


```{r, fig.width=6, fig.height=4}
thebreaks2 <- c(-16, -8, -4, -2, -1, 1, 2, 4, 8, 16)

rawnav_tfixed6 %>%
  mutate(
    accel_next_bin = 
      base::cut(
        accel_next_mph,
        breaks = thebreaks2,
        include.lowest = TRUE,
        ordered_result = TRUE
      )
  ) %>%
  plotly::highlight_key(.,~fps_next) %>%
  plot_rawnav_alt(var = accel_next_bin)
```

So, what's happening at some of these intervals where accel is near 0; 

```{r}

rawnav_fil <-
  rawnav_tfixed6 %>%
  filter_range(34598,35364)

```

```{r}
rawnav_fil2 <-
  rawnav_tfixed6 %>%
  filter_range(18515,20722)
```

what is average speed when no acceleration
```{r}
rawnav_fil2 %>%
  filter(
    (accel_next < 0.5) & (accel_next > -0.5)
  ) %>%
  pull(fps_next) %>%
  summary()
```
# Case 1 diff accel
here, we changed the accel calc to be a bit better, i think

            accel_next = lambda x: (x.fps_next_next - x.fps_next) / (x.sec_past_st_next - x.sec_past_st),


```{r}
rawnav_tfixed6_na <-
  load_rawnav(
    file.path(path_data,"test_checkfixed6_newaccel.csv")
  ) %>%
  mutate(
    mins_past_st = sec_past_st / 60,
    accel_next_mph = accel_next / 1.467
  )
```

Hmm, but actually, it looks a little screwy still with where you see green/red around sec_past_st 1109.
```{r}
thebreaks2 <- c(-16, -8, -4, -2, -1, 1, 2, 4, 8, 16)

rawnav_tfixed6_na %>%
  mutate(
    accel_next_bin = 
      base::cut(
        accel_next_mph,
        breaks = thebreaks2,
        include.lowest = TRUE,
        ordered_result = TRUE
      )
  ) %>%
  plotly::highlight_key(.,~fps_next) %>%
  plot_rawnav_alt(var = accel_next_bin)
```

```{r}
rawnav_fil2_na <-
  rawnav_tfixed6_na %>%
  filter_range(18515,20722)
```


```{r}
rawnav_fil3_na <-
  rawnav_tfixed6_na %>%
  filter_range(17587,18504)
```

# Case 1 diff accel 2
           
           
 accel_next = lambda x: (x.fps_next - x.fps_next_lag) / (x.sec_past_st_next - x.sec_past_st),


```{r}
rawnav_tfixed6_na2 <-
  load_rawnav(
    file.path(path_data,"test_checkfixed6_newaccel2.csv")
  ) %>%
  mutate(
    mins_past_st = sec_past_st / 60,
    accel_next_mph = accel_next / 1.467
  )
```

this approach seems to better visually match the hard accel at start
and the little jitter at odom_ft 17738
```{r}
thebreaks2 <- c(-16, -8, -4, -2, -1, 1, 2, 4, 8, 16)

rawnav_tfixed6_na2 %>%
  mutate(
    accel_next_bin = 
      base::cut(
        accel_next_mph,
        breaks = thebreaks2,
        include.lowest = TRUE,
        ordered_result = TRUE
      )
  ) %>%
  plotly::highlight_key(.,~fps_next) %>%
  plot_rawnav_alt(var = accel_next_bin)
```


```{r}
rawnav_fil3_na2 <-
  rawnav_tfixed6_na %>%
  filter_range(17587,18504)
```

