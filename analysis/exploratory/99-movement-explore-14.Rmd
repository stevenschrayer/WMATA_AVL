---
title: "Movement Explore 14"
output: html_notebook
---

This notebook looks at the result of the decomposition v14 exported.

```{r include=FALSE}
source('99-movement-explore-setup.R', local = TRUE)
```

# Data Loads

```{r}
rawnav_decomp_all <- 
  load_rawnav(
    file.path(path_data,"test_decomp_mov14_all.csv")
  ) 

```

```{r}
wisconsin_corridor_stops <-
  read_csv(
    file = 
      file.path(
        path_sp,
        "Task 3 - Bus Priority",
        "Data",
        "02-processed",
        "wisconsin_corridor_stops.csv"
      ),
    col_types =  cols(
      route = col_character(),
      direction = col_character(),
      pattern = col_double(),
      pattern_destination = col_character(),
      stop_id = col_double(),
      order_ = col_double(),
      stop_sort_order = col_double(),
      geo_description = col_character(),
      stop_sequence = col_double()
    )
  )

wisconsin_corridor_stops_unique <-
  wisconsin_corridor_stops %>%
  distinct(
    stop_id, 
    geo_description
  )

wisconsin_stops_latlong <-
  rawnav_decomp_all %>%
  filter(
    !is.na(stop_id_loc)
  ) %>%
  group_by(
    stop_id = stop_id_loc
  ) %>%
  summarize(
    lat = mean(lat, na.rm = TRUE),
    long = mean(long, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  st_as_sf(
    .,
    coords = c("long", "lat"),
    crs = 4326L, #WGS84
    agr = "constant"
  )
      
wisconsin_corridor_sf <-
  wisconsin_stops_latlong %>%
  left_join(
    wisconsin_corridor_stops_unique,
    by = c("stop_id" = "stop_id")
  ) %>%
  filter(
    !is.na(geo_description)
  )

```

```{r}
glimpse(rawnav_decomp_all)
```

What's going on in the stop areas? This is a quick preview of how some of the values interact together
```{r}
stop_area_check <-
  rawnav_decomp_all %>%
  group_by(
    filename,
    index_run_start,
    stop_id_group,
    stop_case,
    door_case,
    relative_to_firstdoor,
    stop_decomp,
    stop_decomp_ext
  ) %>%
  summarize(
    tot_secs = sum(secs_marg, na.rm = TRUE),
    .groups = "drop"
  ) 
```

# Quick Analyses
## Delay After STop
What stops have relatively the most delay after the stop is served?

```{r}
most_post_stop_delay1 <-
  rawnav_decomp_all %>%
  filter(
    # conditional on serving stop and passengers
    stop_case == 'atstop' & door_case == "doors"
  ) %>%
  group_by(
    filename,
    index_run_start,
    stop_id_group,
    relative_to_firstdoor,
    stop_decomp_ext
  ) %>%
  summarize(
    tot_secs = sum(secs_marg, na.rm = TRUE),
    .groups = "drop"
  ) 

# these extra steps aren't necessary, just trying to show intermediate vals
# note that we're assuming that door open time after the first door open is
# actually delay
most_post_stop_delay2 <-
  most_post_stop_delay1 %>%
  group_by(
    filename,
    index_run_start,
    stop_id_group,
    relative_to_firstdoor
  ) %>%
  summarize(
    tot_secs = sum(tot_secs, na.rm = TRUE),
    .groups = "drop"
  )

most_post_stop_delay3 <-
  most_post_stop_delay2 %>%
  group_by(
    stop_id_group,
    relative_to_firstdoor
  ) %>%
  summarize(
    mean_tot_secs = mean(tot_secs, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    id_cols = stop_id_group,
    names_from = relative_to_firstdoor,
    values_from = mean_tot_secs
  )

most_post_stop_delay4 <-
  wisconsin_corridor_sf %>%
  left_join(
    most_post_stop_delay3,
    by = c("stop_id" = "stop_id_group")
  ) %>%
  filter(
    stop_id != "32089"
  ) %>%
  arrange(
    desc(post)
  )
  
```

This amount of delay seems a little inordinately long. But the tenleytown stop has a Metrorail stop, so that could be part of it.
```{r}
mapview(most_post_stop_delay4, cex = "post", zcol = "post", layer.name = "Average Seconds of Delay <br>After Door Closes/ <br>Before Acceleration <br>for Trips that <br>Made Passenger Stops")
```

What about a farside stop?

```{r}
penn_6_delay1 <-
  rawnav_decomp_all %>%
  filter(
    stop_id_group == 22373
  ) %>%
  filter(
    # conditional on serving stop and passengers
    stop_case == 'atstop' & door_case == "doors"
  ) %>%
  group_by(
    filename,
    index_run_start,
    relative_to_firstdoor
  ) %>%
  summarize(
    tot_secs = sum(secs_marg, na.rm = TRUE),
    start_date_time = first(start_date_time),
    .groups = "drop"
  ) 

penn_6_delay2 <-
  penn_6_delay1 %>%
  mutate(
    trip_hour = lubridate::hour(start_date_time),
    time_period = 
      base::cut(
        trip_hour,
        breaks = c(0,4,6,9,15,19,23,99),
        labels = c("Late_Night","AM_Early","AM_Peak","Midday","PM_Peak","Evening","Late_Night"),
        ordered_result = TRUE,
        include.lowest = TRUE
      )
  )

penn_6_delay3 <-
  penn_6_delay2 %>%
  group_by(
    time_period,
    relative_to_firstdoor
  ) %>%
  summarize(
    mean_secs = round(mean(tot_secs, na.rm = TRUE),0),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = relative_to_firstdoor,
    values_from = mean_secs
  )

penn_6_delay3
```


# Correlation with Travel Time
Which stop

